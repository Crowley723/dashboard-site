{{- if (include "dashboard.generate.configMap" .) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "dashboard.name" . }}
  namespace: {{ template "dashboard.namespace" . }}
  labels: {{ include "dashboard.labels" (merge (dict "Labels" .Values.configMap.labels) .) | nindent 4 }}
  {{- with $annotations := include "dashboard.annotations" (merge (dict "Annotations" .Values.configMap.annotations) .) }}
  annotations: {{ $annotations | nindent 4 }}
  {{- end }}
data:
  {{ .Values.configMap.key | default "config.yaml" }}: |
    ---
    {{- with .Values.config.server }}
    server:
      port: {{ .port | default 8080 }}
      external_url: {{ .external_url | quote }}
      {{- if .debug }}
      debug:
        enabled: {{ .debug.enabled | default false }}
        host: {{ .debug.host | default "127.0.0.1" | quote }}
        port: {{ .debug.port | default 9000 }}
      {{- end }}
    {{- end }}

    {{- with .Values.config.distributed }}
    distributed:
      enabled: {{ .enabled | default false }}
      ttl: {{ .ttl | default "30s" }}
    {{- end }}

    {{- with .Values.config.redis }}
    redis:
      address: {{ .address | quote }}
      session_index: {{ .session_index }}
      cache_index: {{ .cache_index }}
      leader_index: {{ .leader_index }}
      {{- if .sentinel }}
      sentinel:
        master_name: {{ .sentinel.master_name | quote }}
        password: {{ .sentinel.password | quote }}
        {{- if .sentinel.addresses }}
        addresses:
          {{- range .sentinel.addresses }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
      {{- end}}
    {{- end }}

    {{- with .Values.config.oidc }}
    oidc:
      client_id: {{ .client_id | quote }}
      client_secret: {{ .client_secret | quote }}
      issuer_url: {{ .issuer_url | quote }}
      redirect_url: {{ .redirect_url | quote }}
      {{- if .scopes }}
      scopes:
        {{- range .scopes }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      scopes:
        - "openid"
        - "profile"
        - "email"
        - "groups"
      {{- end }}
    {{- end }}

    log:
      level: {{ .Values.config.log.level | default "info" | quote }}
      format: {{ .Values.config.log.format | default "text" | quote }}

    {{- with .Values.config.cors }}
    cors:
      {{- if .allowed_origins }}
      allowed_origins:
        {{- range .allowed_origins }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_origins:
        - "http://localhost:5173"
      {{- end }}
      {{- if .allowed_methods }}
      allowed_methods:
        {{- range .allowed_methods }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
      {{- end }}
      {{- if .allowed_headers }}
      allowed_headers:
        {{- range .allowed_headers }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_headers:
        - "*"
      {{- end }}
      {{- if .exposed_headers }}
      exposed_headers:
        {{- range .exposed_headers }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
      allow_credentials: {{ .allow_credentials | default false }}
      max_age_seconds: {{ .max_age_seconds | default 300 }}
    {{- else }}
    cors:
      allowed_origins:
        - "http://localhost:5173"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
      allowed_headers:
        - "*"
      allow_credentials: false
      max_age_seconds: 300
    {{- end }}

    sessions:
      store: {{ .Values.config.session.store | default "memory" | quote }}
      duration_source: {{ .Values.config.session.duration_source | default "fixed" | quote }}
      fixed_timeout: {{ .Values.config.session.fixed_timeout | default "24h" | quote }}
      name: {{ .Values.config.session.name | default "session_id" | quote }}
      secure: {{ .Values.config.session.secure | default true }}

    {{- with .Values.config.data }}
    data:
      prometheus_url: {{ .prometheus_url | quote }}
      {{- if .fallback_fetch_interval }}
      fallback_fetch_interval: {{ .fallback_fetch_interval | quote }}
      {{- end }}
      {{- if .basic_auth }}
      basic_auth:
        username: {{ .basic_auth.username | quote }}
        password: {{ .basic_auth.password | quote }}
      {{- end }}
      {{- if .queries }}
      queries:
        {{- range .queries }}
        - name: {{ .name | quote }}
          disabled: {{ .disabled }}
          query: {{ .query | quote }}
          type: {{ .type | quote }}
          {{- if .ttl }}
          ttl: {{ .ttl | quote }}
          {{- end }}
          {{- if .range }}
          range: {{ .range | quote }}
          {{- end }}
          {{- if .step }}
          step: {{ .step | quote }}
          {{- end }}
          require_auth: {{ .require_auth | default false }}
          {{- if .required_group }}
          required_group: {{ .required_group | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    cache:
      type: {{ .Values.config.cache.type | default "memory" | quote }}

    {{- with .Values.config.authorization }}
    authorization:
      {{- if .group_scopes }}
      group_scopes:
        {{- range $group, $scopes := .group_scopes }}
        {{ $group }}:
          {{- range $scopes }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- with .Values.config.storage }}
    storage:
      enabled: {{ .enabled | default false }}
      {{- if .enabled }}
      host: {{ .host | quote }}
      port: {{ .port }}
      username: {{ .username | quote }}
      password: {{ .password | quote }}
      database: {{ .database | quote }}
      {{- end }}
    {{- end }}

    {{- with .Values.config.features }}
    features:
      {{- with .mtls_management }}
      mtls_management:
        enabled: {{ .enabled | default false }}
        {{- if .enabled }}
        download_token_hmac_key: {{ .download_token_hmac_key | quote }}
        auto_approve_admin_requests: {{ .auto_approve_admin_requests | default false }}
        allow_admins_to_approve_own_requests: {{ .allow_admins_to_approve_own_requests | default true }}
        min_certificate_validity_days: {{ .min_certificate_validity_days | default 30 }}
        max_certificate_validity_days: {{ .max_certificate_validity_days | default 365 }}
        {{- with .kubernetes }}
        kubernetes:
          namespace: {{ .namespace | default "conduit" | quote }}
          in_cluster: {{ .in_cluster | default true }}
          {{- if .kubeconfig }}
          kubeconfig: {{ .kubeconfig | quote }}
          {{- end }}
        {{- end }}
        {{- with .certificate_issuer }}
        certificate_issuer:
          name: {{ .name | quote }}
          kind: {{ .kind | quote }}
        {{- end }}
        {{- with .certificate_subject }}
        certificate_subject:
          organization: {{ .organization | default "Homelab Conduit" | quote }}
          {{- if .country }}
          country: {{ .country | quote }}
          {{- end }}
          {{- if .locality }}
          locality: {{ .locality | quote }}
          {{- end }}
          {{- if .province }}
          province: {{ .province | quote }}
          {{- end }}
        {{- end }}
        {{- with .background_job_config }}
        background_job_config:
          approved_certificate_polling_interval: {{ .approved_certificate_polling_interval | default "30s" | quote }}
          issued_certificate_polling_interval: {{ .issued_certificate_polling_interval | default "30s" | quote }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- with .firewall_management }}
      firewall_management:
        enabled: {{ .enabled | default false }}
        {{- if .enabled }}
        {{- with .background_job_config }}
        background_job_config:
          sync_interval: {{ .sync_interval | default "5m" | quote }}
          expiration_interval: {{ .expiration_interval | default "1h" | quote }}
        {{- end }}
        {{- if .aliases }}
        aliases:
          {{- range .aliases }}
          - name: {{ .name | quote }}
            uuid: {{ .uuid | quote }}
            description: {{ .description | quote }}
            max_ips_per_user: {{ .max_ips_per_user }}
            max_total_ips: {{ .max_total_ips }}
            {{- if .default_ttl }}
            default_ttl: {{ .default_ttl | quote }}
            {{- else }}
            default_ttl: null
            {{- end }}
            auth_group: {{ .auth_group | quote }}
          {{- end }}
        {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}