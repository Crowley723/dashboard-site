redis:
  image:
    registry: registry.crowleybrynn.com/dockerhub-proxy
    repository: bitnamilegacy/redis
  architecture: replication

  auth:
    enabled: true
    sentinel: true
    existingSecret: "redis-credentials"
    existingSecretPasswordKey: "password"

  master:
    podAffinityPreset: ""
    podAntiAffinityPreset: ""
    nodeAffinityPreset:
      type: ""
      key: ""
      values: []

    # Then set custom affinity
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: redis
                app.kubernetes.io/component: node
            topologyKey: kubernetes.io/hostname
      podAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 50
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: dashboard
                  app.kubernetes.io/component: application
              topologyKey: kubernetes.io/hostname
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: "node-role.kubernetes.io/control-plane"
                  operator: DoesNotExist

    disableCommands:
      - FLUSHDB
      - FLUSHALL
    resourcesPreset: "nano"
    persistence:
      enabled: true
      size: 2Gi
      storageClass: longhorn-static
      accessModes:
        - ReadWriteOnce

  replica:
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: redis
                app.kubernetes.io/component: node
            topologyKey: kubernetes.io/hostname
      podAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 50
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: dashboard
                  app.kubernetes.io/component: application
              topologyKey: kubernetes.io/hostname
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: "node-role.kubernetes.io/control-plane"
                  operator: DoesNotExist
    replicaCount: 3
    disableCommands:
      - FLUSHDB
      - FLUSHALL
    resourcesPreset: "nano"
    persistence:
      enabled: true
      size: 2Gi
      storageClass: longhorn-static
      accessModes:
        - ReadWriteOnce

  sentinel:
    image:
      registry: registry.crowleybrynn.com/dockerhub-proxy
      repository: bitnamilegacy/redis-sentinel
    enabled: true
    quorum: 2
    downAfterMilliseconds: 30000
    failoverTimeout: 180000

  networkPolicy:
    enabled: true
    allowExternal: true

  metrics:
    enabled: false

deployment:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1

  labels:
    app.kubernetes.io/name: dashboard
    app.kubernetes.io/component: application
  annotations:
    profiles.grafana.com/cpu.scrape: "true"
    profiles.grafana.com/cpu.port: "9000"
    profiles.grafana.com/cpu.path: "/debug/pprof/profile"
    profiles.grafana.com/memory.scrape: "true"
    profiles.grafana.com/memory.port: "9000"
    profiles.grafana.com/memory.path: "/debug/pprof/heap"
    profiles.grafana.com/goroutine.scrape: "true"
    profiles.grafana.com/goroutine.port: "9000"
    profiles.grafana.com/goroutine.path: "/debug/pprof/goroutine"
    profiles.grafana.com/allocs.scrape: "true"
    profiles.grafana.com/allocs.port: "9000"
    profiles.grafana.com/allocs.path: "/debug/pprof/allocs"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9000"
    prometheus.io/path: "/metrics"
  image:
    repository: "ghcr.io/crowley723/dashboard-site"
    tag: "prod"
    pullPolicy: "Always"

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: "node-role.kubernetes.io/control-plane"
                operator: DoesNotExist
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: dashboard
          topologyKey: kubernetes.io/hostname


  container:
    name: "dashboard"
#    command: [ "sleep" ]
#    args: [ "infinity" ]

    envFrom:
      - secretRef:
          name: dashboard-secrets
      - secretRef:
          name: redis-credentials

    resources:
      limits:
        cpu: 200m
        memory: 512Mi
      requests:
        cpu: 0m
        memory: 0Mi

service:
  enabled: true
  type: ClusterIP
  port: 80
  targetPort: http

ingressRoute:
  enabled: true
  entryPoints:
    - websecure
  routes:
    - match: "Host(`crowleybrynn.com`) || Host(`www.crowleybrynn.com`)"
      servicePort: 80
  tls:
    secretName: tls-wildcard-crowleybrynn-com

  tcpRoute:
    enabled: false

configMap:
  generate: true
  key: "config.yaml"

config:
  server:
    port: 8080
    debug:
      enabled: true
      host: 127.0.0.1
      port: 9000

  log:
    level: "info"
    format: "text"

  cors:
    allowed_origins:
      - "https://crowleybrynn.com/api/auth/callback"
      - "https://www.crowleybrynn.com/api/auth/callback"
    allowCredentials: true
    maxAge: 300

  session:
    store: 'memory'
    duration_source: 'fixed'
    secure: false

  cache:
    type: 'memory'

  oidc:
    scopes:
      - 'openid'
      - 'profile'
      - 'email'
      - 'groups'

  data:
    queries:
      - name: 'up'
        query: 'up{source="kubernetes", app!="", component!=""}'
        ttl: '10m'
      - name: 'node_status'
        query: 'kube_node_status_condition{condition="Ready",status="true"}'
        ttl: '10m'
      - name: "pods_running_per_namespace"
        query: 'count by (namespace)(kube_pod_status_phase{phase="Running"})'
        ttl: '10m'

      - name: 'traefik_requests_7d_avg'
        query: 'sum(rate(traefik_service_requests_total[7d]))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'
      - name: 'traefik_requests_5m_avg'
        query: 'sum(rate(traefik_service_requests_total[5m]))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'

      - name: 'traefik_requests_total_1h'
        query: 'sum(rate(traefik_service_requests_total[5m])) * 60'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'traefik_requests_total_7d'
        query: 'sum(rate(traefik_service_requests_total[1d])) * 3600'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'

      - name: 'total_cluster_cpu_perc_1h'
        query: '100 * (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'total_cluster_cpu_perc_7d'
        query: '100 * (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[1d])))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'

      - name: 'code_400_average_1day'
        disabled: true
        query: 'sum(rate(traefik_service_requests_total{code=~"4.."}[1h])) / sum(rate(traefik_service_requests_total[1h])) * 100'
        type: 'range'
        range: '1d'
        step: '1h'
        ttl: '1h'
      - name: 'code_500_average_1day'
        disabled: true
        query: 'sum(rate(traefik_service_requests_total{code=~"5.."}[1h])) / sum(rate(traefik_service_requests_total[1h])) * 100'
        type: 'range'
        range: '1d'
        step: '1h'
        ttl: '1h'
      - name: 'total_cluster_memory_perc_1h'
        disabled: true
        query: '100 * (1 - sum(node_memory_MemAvailable_bytes) / sum(node_memory_MemTotal_bytes))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'total_cluster_memory_perc_7d'
        disabled: true
        query: '100 * (1 - sum(node_memory_MemAvailable_bytes) / sum(node_memory_MemTotal_bytes))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'
      - name: 'pod_restarts_last_1h'
        disabled: true
        query: 'increase(kube_pod_container_status_restarts_total[1h])'
        ttl: '1m'