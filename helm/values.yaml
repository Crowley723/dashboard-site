deployment:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1

  image:
    repository: "ghcr.io/crowley723/dashboard-site"
    tag: "prod"
    pullPolicy: "Always"

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: "node-role.kubernetes.io/control-plane"
                operator: DoesNotExist
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: dashboard
          topologyKey: kubernetes.io/hostname


  container:
    name: "dashboard"
#    command: [ "sleep" ]
#    args: [ "infinity" ]

    envFrom:
      - secretRef:
          name: dashboard-secrets

    resources:
      limits:
        cpu: 200m
        memory: 512Mi
      requests:
        cpu: 0m
        memory: 0Mi

service:
  enabled: true
  type: ClusterIP
  port: 80
  targetPort: http

ingressRoute:
  enabled: true
  entryPoints:
    - websecure
  routes:
    - match: "Host(`crowleybrynn.com`) || Host(`www.crowleybrynn.com`)"
      servicePort: 80
  tls:
    secretName: tls-wildcard-crowleybrynn-com

  tcpRoute:
    enabled: false

configMap:
  generate: true
  key: "config.yaml"

config:
  server:
    port: 8080

  log:
    level: "info"
    format: "text"

  cors:
    allowed_origins:
      - "https://crowleybrynn.com/api/auth/callback"
      - "https://www.crowleybrynn.com/api/auth/callback"
    allowCredentials: true
    maxAge: 300

  session:
    store: 'memory'
    duration_source: 'fixed'
    secure: false

  cache:
    type: 'memory'

  oidc:
    scopes:
      - 'openid'
      - 'profile'
      - 'email'
      - 'groups'

  data:
    time_interval: '10m'
    queries:
      - name: 'up'
        query: 'up{source="kubernetes", app!="", component!=""}'
        ttl: '10m'
      - name: 'node_status'
        query: 'kube_node_status_condition{condition="Ready",status="true"}'
        ttl: '10m'
      - name: "pods_running_per_namespace"
        query: 'count by (namespace)(kube_pod_status_phase{phase="Running"})'
        ttl: '10m'

      - name: 'traefik_requests_7d_avg'
        query: 'sum(rate(traefik_service_requests_total[7d]))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'
      - name: 'traefik_requests_5m_avg'
        query: 'sum(rate(traefik_service_requests_total[5m]))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'

      - name: 'traefik_requests_total_1h'
        query: 'sum(rate(traefik_service_requests_total[5m])) * 60'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'traefik_requests_total_7d'
        query: 'sum(rate(traefik_service_requests_total[1d])) * 3600'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'

      - name: 'total_cluster_cpu_perc_1h'
        query: '100 * (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'total_cluster_cpu_perc_7d'
        query: '100 * (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[1d])))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'

      - name: 'code_400_average_1day'
        disabled: true
        query: 'sum(rate(traefik_service_requests_total{code=~"4.."}[1h])) / sum(rate(traefik_service_requests_total[1h])) * 100'
        type: 'range'
        range: '1d'
        step: '1h'
        ttl: '1h'
      - name: 'code_500_average_1day'
        disabled: true
        query: 'sum(rate(traefik_service_requests_total{code=~"5.."}[1h])) / sum(rate(traefik_service_requests_total[1h])) * 100'
        type: 'range'
        range: '1d'
        step: '1h'
        ttl: '1h'
      - name: 'total_cluster_memory_perc_1h'
        disabled: true
        query: '100 * (1 - sum(node_memory_MemAvailable_bytes) / sum(node_memory_MemTotal_bytes))'
        type: 'range'
        range: '1h'
        step: '1m'
        ttl: '1m'
      - name: 'total_cluster_memory_perc_7d'
        disabled: true
        query: '100 * (1 - sum(node_memory_MemAvailable_bytes) / sum(node_memory_MemTotal_bytes))'
        type: 'range'
        range: '7d'
        step: '1h'
        ttl: '1h'
      - name: 'pod_restarts_last_1h'
        disabled: true
        query: 'increase(kube_pod_container_status_restarts_total[1h])'
        ttl: '1m'