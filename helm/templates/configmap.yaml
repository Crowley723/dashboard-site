{{- if (include "dashboard.generate.configMap" .) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "dashboard.name" . }}
  namespace: {{ template "dashboard.namespace" . }}
  labels: {{ include "dashboard.labels" (merge (dict "Labels" .Values.configMap.labels) .) | nindent 4 }}
  {{- with $annotations := include "dashboard.annotations" (merge (dict "Annotations" .Values.configMap.annotations) .) }}
  annotations: {{ $annotations | nindent 4 }}
  {{- end }}
data:
  {{ .Values.configMap.key | default "config.yaml" }}: |
    ---
    {{- with .Values.config.server }}
    server:
      port: {{ .port | default 8080 }}
      {{- if .debug }}
      debug:
        enabled: {{ .debug.enabled | default false }}
        host: {{ .debug.host | default "127.0.0.1" | quote }}
        port: {{ .debug.port | default 9000 }}
      {{- end }}
    {{- end }}

    {{- with .Values.config.distributed }}
    distributed:
      enabled: {{ .enabled | default false }}
      ttl: {{ .ttl | default "30s" }}
    {{- end }}

    {{- with .Values.config.redis }}
    redis:
      address: {{ .address | quote }}
      session_index: {{ .session_index }}
      cache_index: {{ .cache_index }}
      leader_index: {{ .leader_index }}
      {{- if .sentinel }}
      sentinel:
        master_name: {{ .sentinel.master_name | quote }}
        password: {{ .sentinel.password | quote }}
        {{- if .sentinel.addresses }}
        addresses:
          {{- range .sentinel.addresses }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
      {{- end}}

    {{- end }}

    {{- with .Values.config.oidc }}
    oidc:
      client_id: {{ .client_id | quote }}
      client_secret: {{ .client_secret | quote }}
      issuer_url: {{ .issuer_url | quote }}
      redirect_url: {{ .redirect_url | quote }}
      {{- if .scopes }}
      scopes:
        {{- range .scopes }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      scopes:
        - "openid"
        - "profile"
        - "email"
        - "groups"
      {{- end }}
    {{- end }}

    log:
      level: {{ .Values.config.log.level | default "info" | quote }}
      format: {{ .Values.config.log.format | default "text" | quote }}

    {{- with .Values.config.cors }}
    cors:
      {{- if .allowed_origins }}
      allowed_origins:
        {{- range .allowed_origins }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_origins:
        - "http://localhost:5173"
      {{- end }}
      {{- if .allowed_methods }}
      allowed_methods:
        {{- range .allowed_methods }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
      {{- end }}
      {{- if .allowed_headers }}
      allowed_headers:
        {{- range .allowed_headers }}
        - {{ . | quote }}
        {{- end }}
      {{- else }}
      allowed_headers:
        - "*"
      {{- end }}
      {{- if .exposed_headers }}
      exposed_headers:
        {{- range .exposed_headers }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
      allow_credentials: {{ .allow_credentials | default false }}
      max_age_seconds: {{ .max_age_seconds | default 300 }}
    {{- else }}
    cors:
      allowed_origins:
        - "http://localhost:5173"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
      allowed_headers:
        - "*"
      allow_credentials: false
      max_age_seconds: 300
    {{- end }}

    sessions:
      store: {{ .Values.config.session.store | default "memory" | quote }}
      duration_source: {{ .Values.config.session.duration_source | default "fixed" | quote }}
      fixed_timeout: {{ .Values.config.session.fixed_timeout | default "24h" | quote }}
      name: {{ .Values.config.session.name | default "session_id" | quote }}
      secure: {{ .Values.config.session.secure | default true }}

    {{- with .Values.config.data }}
    data:
      prometheus_url: {{ .prometheus_url | quote }}
      {{- if .fallback_fetch_interval }}
      fallback_fetch_interval: {{ .fallback_fetch_interval | quote }}
      {{- end }}
      {{- if .basic_auth }}
      basic_auth:
        username: {{ .basic_auth.username | quote }}
        password: {{ .basic_auth.password | quote }}
      {{- end }}
      {{- if .queries }}
      queries:
        {{- range .queries }}
        - name: {{ .name | quote }}
          disabled: {{ .disabled }}
          query: {{ .query | quote }}
          type: {{ .type | quote }}
          {{- if .ttl }}
          ttl: {{ .ttl | quote }}
          {{- end }}
          {{- if .range }}
          range: {{ .range | quote }}
          {{- end }}
          {{- if .step }}
          step: {{ .step | quote }}
          {{- end }}
          require_auth: {{ .require_auth | default false }}
          {{- if .required_group }}
          required_group: {{ .required_group | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    cache:
      type: {{ .Values.config.cache.type | default "memory" | quote }}
{{- end }}