name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - rc
          - stable
      rc_number:
        description: 'RC number (only used with rc bump type, e.g., 1 for rc1, 2 for rc2)'
        required: false
        default: '1'

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Harden Runner'
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: 'audit'

      - name: 'Checkout'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Calculate New Version
        id: new_version
        run: |
          CURRENT_VERSION=$(cat VERSION | tr -d '\n')

          if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-rc([0-9]+))?$ ]]; then
            major="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            patch="${BASH_REMATCH[3]}"
            current_rc="${BASH_REMATCH[5]}"
          else
            echo "Error: Invalid version format: $CURRENT_VERSION"
            exit 1
          fi

          case "${{ inputs.bump_type }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              NEW_VERSION="$major.$minor.$patch"
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              NEW_VERSION="$major.$minor.$patch"
              ;;
            patch)
              patch=$((patch + 1))
              NEW_VERSION="$major.$minor.$patch"
              ;;
            rc)
              if [ -z "$current_rc" ]; then
                patch=$((patch + 1))
              fi
              NEW_VERSION="$major.$minor.$patch-rc${{ inputs.rc_number }}"
              ;;
            stable)
              if [ -z "$current_rc" ]; then
                echo "Error: Current version is already stable"
                exit 1
              fi
              NEW_VERSION="$major.$minor.$patch"
              ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update Version Files
        run: |
          chmod +x scripts/sync-version.sh
          ./scripts/sync-version.sh ${{ steps.new_version.outputs.version }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="version-bump-${{ steps.new_version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"
          git push origin "$BRANCH_NAME"

          PR_BODY="Automated version bump from ${{ steps.new_version.outputs.current }} to ${{ steps.new_version.outputs.version }}

          Bump type: ${{ inputs.bump_type }}
          ${{ inputs.bump_type == 'rc' && format('RC number: {0}', inputs.rc_number) || '' }}

          Files updated:
          - VERSION
          - helm/Chart.yaml
          - web/package.json

          After merging this PR, create a git tag:
          \`\`\`bash
          git tag -a v${{ steps.new_version.outputs.version }} -m \"Release v${{ steps.new_version.outputs.version }}\"
          git push --tags
          \`\`\`"

          RESPONSE=$(curl -L -s -w "\n%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "$(jq -n \
              --arg title "chore: bump version to ${{ steps.new_version.outputs.version }}" \
              --arg body "$PR_BODY" \
              --arg head "$BRANCH_NAME" \
              --arg base "main" \
              '{title: $title, body: $body, head: $head, base: $base}'
            )")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 201 ]; then
            echo "$BODY" | jq -r '.html_url'
          else
            echo "PR creation failed with HTTP $HTTP_CODE"
            echo "$BODY" | jq '.'
            exit 1
          fi
